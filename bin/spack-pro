#!/usr/bin/env node

const program = require('commander')
const App = require('../lib/app')
const server = require('../lib/server')
process.env.NODE_ENV = 'production'
program
  .usage('[options]')
  .option('-c,--clean', 'ignore file version,rebuild all files')
  .option('-d,--directory', 'work directory')
  .option('-p,--port', 'web server port')
  .option('-s,--server', 'web server')
  .parse(process.argv)

const config = {
  //umd alias path
  alias: {
    'axios': {
      path: 'dist/axios.js'
      //publicKey:axios,和key相同可以不写
    },
    'react-dom': {
      path: 'umd/react-dom.development.js',
      publicKey:'ReactDOM',
      deps: ['react']
    },
    'react': {
      path: 'umd/react.development.js',
      publicKey:'React'
    }
  },
  clean: false,
  runtime: ['runtime/hotload.js'],
  destination: "dist",
  directory: process.cwd(),
  plugins: {
    ensureString: true,
    image: true,
    version: true,
    vue: true,
    buble: true,
    parser: true,
    compileVue: true,
    node: true,
    compress: true,
    upload: true,
    htmlPro: true
  },
  package: []
}
if (program.directory) {
  config.directory = program.directory
}
if (program.clean) {
  config.clean = true
}

const app = new App('config-pro.js', config)
app.build().then(() => {
  if (program.server) {
    server.init({
      app,
      port: program.port || 3000
    })
  }
})
